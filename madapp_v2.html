<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üçΩÔ∏è Hvad spiste vi?</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 42px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 20px;
            text-align: center;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.4s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .dish-input-container {
            text-align: center;
            padding: 20px;
        }
        
        .dish-input {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            font-size: 24px;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .big-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 28px;
            font-weight: 700;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }
        
        .big-button:active {
            transform: scale(0.95);
        }
        
        .rater-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .rater-name {
            font-size: 48px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }
        
        .rater-emoji {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
        }
        
        .stars {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .star {
            font-size: 70px;
            cursor: pointer;
            transition: all 0.2s;
            color: #ddd;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .star:active {
            transform: scale(1.2);
        }
        
        .star.filled {
            color: #ffc107;
            animation: starPop 0.3s;
        }
        
        @keyframes starPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .next-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 28px;
            font-weight: 700;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
            transition: all 0.3s;
        }
        
        .next-button:active {
            transform: scale(0.95);
        }
        
        .next-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            border-left: 6px solid #667eea;
        }
        
        .summary-name {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .summary-stars {
            font-size: 32px;
            color: #ffc107;
        }
        
        .average-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            margin: 30px 0;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }
        
        .average-score {
            font-size: 80px;
            font-weight: 700;
            margin: 20px 0;
        }
        
        .history-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4);
        }
        
        .history-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }
        
        .history-dish {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .history-date {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .history-ratings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .history-rating {
            font-size: 16px;
            color: #666;
        }
        
        .report-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .report-stat-number {
            font-size: 56px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .report-stat-label {
            font-size: 20px;
            opacity: 0.9;
        }
        
        .top-dish-card {
            background: #fff3cd;
            border: 3px solid #ffc107;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .top-dish-card::before {
            content: "üèÜ";
            position: absolute;
            top: -15px;
            right: 20px;
            font-size: 40px;
        }
        
        .top-dish-name {
            font-size: 26px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .top-dish-rating {
            font-size: 32px;
            color: #ffc107;
        }
        
        .top-dish-count {
            font-size: 18px;
            color: #666;
            margin-top: 8px;
        }
        
        .rater-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .rater-stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .rater-stat-emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .rater-stat-name {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .rater-stat-avg {
            font-size: 28px;
            color: #ffc107;
        }
        
        .badge-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1000;
            text-align: center;
            animation: badgeAppear 0.5s forwards;
            max-width: 500px;
        }
        
        @keyframes badgeAppear {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); }
            70% { transform: translate(-50%, -50%) scale(1.1) rotate(10deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }
        
        .badge-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            animation: fadeIn 0.3s;
        }
        
        .badge-icon {
            font-size: 100px;
            margin-bottom: 20px;
            animation: bounce 0.6s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .badge-title {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .badge-description {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .badge-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .badge-card.earned {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffc107;
            transform: scale(1.05);
        }
        
        .badge-card.locked {
            opacity: 0.4;
        }
        
        .badge-card-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .badge-card-name {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .badge-card-progress {
            font-size: 12px;
            color: #666;
        }
        
        .extra-questions {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 20px;
            margin-top: 20px;
        }
        
        .question-section {
            margin-bottom: 25px;
        }
        
        .question-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .checkbox-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 3px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-item.checked {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .checkbox-item-emoji {
            font-size: 32px;
        }
        
        .checkbox-item-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .veggie-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .veggie-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .veggie-item.selected {
            background: #d4edda;
            border-color: #28a745;
            transform: scale(1.05);
        }
        
        .veggie-emoji {
            font-size: 36px;
            display: block;
            margin-bottom: 5px;
        }
        
        .veggie-name {
            font-size: 14px;
            color: #333;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px;
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 32px;
            }
            
            .star {
                font-size: 50px;
            }
            
            .rater-emoji {
                font-size: 60px;
            }
            
            .rater-name {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçΩÔ∏è Hvad spiste vi?</h1>
        <p class="subtitle">Giv stjerner til aftensmaden!</p>

        <!-- Screen 1: Input dish name -->
        <div id="dishScreen" class="screen active">
            <div class="dish-input-container">
                <input type="text" id="dishInput" class="dish-input" placeholder="Hvad spiste vi i dag?" autofocus>
                <button class="big-button" onclick="startRating()">Start rating! ‚≠ê</button>
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="history-button" onclick="showHistory()">üìä Se historik</button>
                <button class="history-button" onclick="showReports()">üìà Rapporter</button>
                <button class="history-button" onclick="showBadges()">üèÜ Badges</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="history-button" onclick="showSettings()" style="background: #6c757d;">‚öôÔ∏è Indstillinger</button>
            </div>
        </div>
        
        <!-- Screen 2-5: Rating screens -->
        <div id="ratingScreen" class="screen"></div>
        
        <!-- Extra questions screen -->
        <div id="extraQuestionsScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 36px;">üåü Ekstra sp√∏rgsm√•l</h2>
            <div class="extra-questions">
                <div class="question-section">
                    <div class="question-title">üçΩÔ∏è Hvem spiste alt op?</div>
                    <div class="checkbox-group" id="ateAllCheckboxes"></div>
                </div>
                
                <div class="question-section">
                    <div class="question-title">ü•¶ Hvilke gr√∏ntsager var der?</div>
                    <div class="veggie-grid" id="veggieGrid"></div>
                </div>
                
                <div class="question-section">
                    <div class="question-title">‚ú® Andet</div>
                    <div class="checkbox-group">
                        <div class="checkbox-item" onclick="toggleCheckbox(this, 'triedNew')">
                            <span class="checkbox-item-emoji">üß™</span>
                            <span class="checkbox-item-text">Smagte noget nyt</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleCheckbox(this, 'helpedOut')">
                            <span class="checkbox-item-emoji">üëè</span>
                            <span class="checkbox-item-text">Nogen hjalp til</span>
                        </div>
                    </div>
                </div>
                
                <div class="question-section">
                    <div class="question-title">üç¥ Hvem hjalp med bordet?</div>
                    <div class="checkbox-group" id="tableHelpCheckboxes"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="next-button" onclick="askAboutQuiz()">N√¶ste ‚Üí</button>
            </div>
        </div>
        
        <!-- Ingredient quiz screen -->
        <div id="quizScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px; font-size: 36px;">üéØ Bertas Quiz!</h2>
            <p style="text-align: center; color: #666; font-size: 20px; margin-bottom: 30px;">
                Hvad var der i maden?
            </p>
            
            <div id="quizContent"></div>
        </div>
        
        <!-- Screen 6: Summary -->
        <div id="summaryScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 36px;">üéâ Resultat</h2>
            <div id="summaryContent"></div>
            <div style="text-align: center; margin-top: 40px;">
                <button class="big-button" onclick="reset()">Rate mere mad! üç¥</button>
            </div>
        </div>
        
        <!-- History screen -->
        <div id="historyScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 36px;">üìä Madhistorik</h2>
            <div id="historyList" class="history-list"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-button" onclick="showDishScreen()">‚Üê Tilbage</button>
            </div>
        </div>
        
        <!-- Reports screen -->
        <div id="reportsScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 36px;">üìà Rapporter</h2>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <button class="history-button" onclick="showReport('week')" id="weekBtn">Denne uge</button>
                <button class="history-button" onclick="showReport('month')" id="monthBtn">Denne m√•ned</button>
                <button class="history-button" onclick="showReport('all')" id="allBtn">Alt</button>
            </div>
            
            <div id="reportContent"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-button" onclick="showDishScreen()">‚Üê Tilbage</button>
            </div>
        </div>
        
        <!-- Badges screen -->
        <div id="badgesScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px; font-size: 36px;">üèÜ Badges</h2>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <button class="history-button" onclick="showBadgesFor('Mor')" id="morBadgeBtn">üë© Mor</button>
                <button class="history-button" onclick="showBadgesFor('Far')" id="farBadgeBtn">üë® Far</button>
                <button class="history-button" onclick="showBadgesFor('Berta')" id="bertaBadgeBtn">üëß Berta</button>
                <button class="history-button" onclick="showBadgesFor('Kaj')" id="kajBadgeBtn">üë∂ Kaj</button>
            </div>
            
            <div id="badgesContent"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-button" onclick="showDishScreen()">‚Üê Tilbage</button>
            </div>
        </div>
        
        <!-- Settings screen -->
        <div id="settingsScreen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 36px;">‚öôÔ∏è Indstillinger</h2>
            
            <div style="background: #f8f9fa; padding: 30px; border-radius: 20px; margin-bottom: 20px;">
                <h3 style="font-size: 24px; margin-bottom: 20px; color: #333;">üé® V√¶lg Avatar</h3>
                <div id="avatarPickers"></div>
            </div>
            
            <div style="background: #fff3cd; padding: 30px; border-radius: 20px; border: 3px solid #ffc107;">
                <h3 style="font-size: 24px; margin-bottom: 15px; color: #333;">üóëÔ∏è Nulstil Data</h3>
                <p style="color: #666; margin-bottom: 20px;">Dette sletter alle ratings, badges og historik!</p>
                <button class="big-button" onclick="clearAllData()" style="background: #dc3545;">Slet alt data</button>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-button" onclick="showDishScreen()">‚Üê Tilbage</button>
            </div>
        </div>
    </div>

    <!-- Badge popup -->
    <div id="badgePopup" style="display: none;"></div>

    <script>
        const raters = [
            { name: 'Mor', emoji: 'üë©' },
            { name: 'Far', emoji: 'üë®' },
            { name: 'Berta', emoji: 'üëß' },
            { name: 'Kaj', emoji: 'üë∂' }
        ];
        
        const availableAvatars = {
            'Berta': ['üëß', 'üßí', 'üë±‚Äç‚ôÄÔ∏è', 'ü¶Ñ', 'üåà', 'üé®', 'ü¶ã', 'üå∏', 'üê±', 'üê∞', 'ü¶ä', 'üêº'],
            'Kaj': ['üë∂', 'üë¶', 'üßí', 'üöÇ', 'üöÄ', 'ü¶ï', 'üê∂', 'üêª', 'ü¶Å', 'üêò', 'üêô', 'üöó']
        };
        
        const vegetables = [
            { name: 'Broccoli', emoji: 'ü•¶' },
            { name: 'Guler√∏dder', emoji: 'ü•ï' },
            { name: 'Tomater', emoji: 'üçÖ' },
            { name: 'Agurk', emoji: 'ü•í' },
            { name: 'Peberfrugt', emoji: 'ü´ë' },
            { name: 'Salat', emoji: 'ü•¨' },
            { name: '√Ürter', emoji: 'ü´õ' },
            { name: 'Majs', emoji: 'üåΩ' },
            { name: 'L√∏g', emoji: 'üßÖ' }
        ];
        
        const commonIngredients = [
            { name: 'Kylling', emoji: 'üçó' },
            { name: 'Oksek√∏d', emoji: 'ü•©' },
            { name: 'Svinek√∏d', emoji: 'ü•ì' },
            { name: 'Fisk', emoji: 'üêü' },
            { name: 'Pasta', emoji: 'üçù' },
            { name: 'Ris', emoji: 'üçö' },
            { name: 'Kartofler', emoji: 'ü•î' },
            { name: 'Nudler', emoji: 'üçú' },
            { name: 'Ost', emoji: 'üßÄ' },
            { name: '√Üg', emoji: 'ü•ö' }
        ];
        
        let currentDish = '';
        let currentRaterIndex = 0;
        let ratings = {};
        let extraData = {
            ateAll: [],
            vegetables: [],
            triedNew: false,
            helpedOut: false,
            tableHelp: {
                setTable: [],
                clearTable: []
            },
            ingredients: []
        };
        let history = [];
        let userBadges = {
            'Mor': [],
            'Far': [],
            'Berta': [],
            'Kaj': []
        };
        let quizScore = {
            'Mor': 0,
            'Far': 0,
            'Berta': 0,
            'Kaj': 0
        };
        
        // Global audio context - create once and reuse
        let audioContext = null;
        
        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        function loadHistory() {
            const saved = localStorage.getItem('madRatings');
            if (saved) {
                history = JSON.parse(saved);
            }
            const savedBadges = localStorage.getItem('userBadges');
            if (savedBadges) {
                userBadges = JSON.parse(savedBadges);
            }
            const savedAvatars = localStorage.getItem('userAvatars');
            if (savedAvatars) {
                const avatars = JSON.parse(savedAvatars);
                raters.forEach(rater => {
                    if (avatars[rater.name]) {
                        rater.emoji = avatars[rater.name];
                    }
                });
            }
            const savedQuizScore = localStorage.getItem('quizScore');
            if (savedQuizScore) {
                quizScore = JSON.parse(savedQuizScore);
            }
        }
        
        function saveAvatars() {
            const avatars = {};
            raters.forEach(rater => {
                avatars[rater.name] = rater.emoji;
            });
            localStorage.setItem('userAvatars', JSON.stringify(avatars));
        }
        
        function clearAllData() {
            if (confirm('Er du HELT sikker? Alt vil blive slettet! üóëÔ∏è')) {
                if (confirm('Sidste chance! Slet virkelig ALT?')) {
                    // Clear ALL localStorage completely
                    localStorage.clear();
                    
                    alert('Alt data er slettet! ‚úÖ');
                    
                    // Force complete page reload
                    window.location.href = window.location.href;
                }
            }
        }
        
        function showSettings() {
            renderAvatarPickers();
            showScreen('settingsScreen');
        }
        
        function renderAvatarPickers() {
            const html = ['Berta', 'Kaj'].map(name => {
                const rater = raters.find(r => r.name === name);
                const avatars = availableAvatars[name];
                
                return `
                    <div style="margin-bottom: 30px;">
                        <div style="font-size: 20px; font-weight: 700; color: #333; margin-bottom: 15px;">
                            ${rater.emoji} ${name}'s avatar
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                            ${avatars.map(avatar => `
                                <div onclick="selectAvatar('${name}', '${avatar}')" 
                                     style="font-size: 48px; cursor: pointer; text-align: center; 
                                            padding: 15px; border-radius: 15px; transition: all 0.3s;
                                            background: ${rater.emoji === avatar ? '#d4edda' : 'white'};
                                            border: 3px solid ${rater.emoji === avatar ? '#28a745' : '#e0e0e0'};">
                                    ${avatar}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('avatarPickers').innerHTML = html;
        }
        
        function selectAvatar(name, emoji) {
            const rater = raters.find(r => r.name === name);
            rater.emoji = emoji;
            saveAvatars();
            renderAvatarPickers();
        }
        
        function saveHistory() {
            localStorage.setItem('madRatings', JSON.stringify(history));
            localStorage.setItem('userBadges', JSON.stringify(userBadges));
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function startRating() {
            currentDish = document.getElementById('dishInput').value.trim();
            if (!currentDish) {
                alert('Skriv hvad I spiste! üòä');
                return;
            }
            
            // Ask if there are guests - now more prominent
            const hasGuest = confirm('üéâ Er der en g√¶st/ven der vil rate med?\n\n(For eksempel Bertas veninde)\n\nTryk OK for JA, Annuller for NEJ');
            
            if (hasGuest) {
                const guestName = prompt('‚ú® Hvad hedder g√¶sten?', '');
                if (guestName && guestName.trim()) {
                    // Select emoji for guest
                    const guestEmojis = ['üë§', 'üßë', 'üëß', 'üë¶', 'üåü', '‚≠ê', '‚ú®', 'üéà'];
                    const randomEmoji = guestEmojis[Math.floor(Math.random() * guestEmojis.length)];
                    
                    // Add guest temporarily
                    raters.push({ name: guestName.trim(), emoji: randomEmoji, isGuest: true });
                    alert(`${randomEmoji} ${guestName.trim()} er nu med! üéâ`);
                }
            }
            
            currentRaterIndex = 0;
            ratings = {};
            showRatingScreen();
        }
        
        function showRatingScreen() {
            const rater = raters[currentRaterIndex];
            const screen = document.getElementById('ratingScreen');
            
            screen.innerHTML = `
                <div class="rater-card">
                    <span class="rater-emoji">${rater.emoji}</span>
                    <div class="rater-name">${rater.name}</div>
                    <p style="font-size: 24px; color: #666;">Hvor mange stjerner giver du til</p>
                    <p style="font-size: 28px; font-weight: 700; color: #333; margin-top: 10px;">${currentDish}?</p>
                    
                    <div class="stars">
                        ${[1,2,3,4,5].map(star => `
                            <span class="star" onclick="rateDish(${star})">‚òÖ</span>
                        `).join('')}
                    </div>
                </div>
            `;
            
            showScreen('ratingScreen');
        }
        
        function rateDish(stars) {
            const rater = raters[currentRaterIndex];
            ratings[rater.name] = stars;
            
            // Play sound based on rating
            playRatingSound(stars);
            
            // Animate the selected star
            const starElements = document.querySelectorAll('.star');
            for (let i = 0; i < stars; i++) {
                starElements[i].classList.add('filled');
            }
            
            setTimeout(() => {
                currentRaterIndex++;
                
                if (currentRaterIndex < raters.length) {
                    showRatingScreen();
                } else {
                    showExtraQuestions();
                }
            }, 800);
        }
        
        function playRatingSound(stars) {
            try {
                const ctx = getAudioContext();
                
                // Resume context if suspended (browser autoplay policy)
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // Different sounds for different ratings
                const sounds = {
                    1: { freq: 200, duration: 0.3, type: 'sawtooth' }, // √òv lyd
                    2: { freq: 300, duration: 0.3, type: 'sine' },
                    3: { freq: 400, duration: 0.3, type: 'sine' },
                    4: { freq: 600, duration: 0.4, type: 'sine' },
                    5: { freq: 800, duration: 0.5, type: 'sine' } // YEAH lyd
                };
                
                const sound = sounds[stars];
                oscillator.frequency.value = sound.freq;
                oscillator.type = sound.type;
                
                const now = ctx.currentTime;
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + sound.duration);
                
                oscillator.start(now);
                oscillator.stop(now + sound.duration);
                
                // Extra "YEAH!" effect for 5 stars
                if (stars === 5) {
                    setTimeout(() => {
                        const osc2 = ctx.createOscillator();
                        const gain2 = ctx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        osc2.frequency.value = 1000;
                        osc2.type = 'sine';
                        const now2 = ctx.currentTime;
                        gain2.gain.setValueAtTime(0.15, now2);
                        gain2.gain.exponentialRampToValueAtTime(0.01, now2 + 0.3);
                        osc2.start(now2);
                        osc2.stop(now2 + 0.3);
                    }, 150);
                }
            } catch (e) {
                console.log('Audio not supported:', e);
            }
        }
        
        function showExtraQuestions() {
            // Render ate all checkboxes
            const ateAllHTML = raters.map(rater => `
                <div class="checkbox-item" onclick="toggleAteAll('${rater.name}', this)">
                    <span class="checkbox-item-emoji">${rater.emoji}</span>
                    <span class="checkbox-item-text">${rater.name}</span>
                </div>
            `).join('');
            document.getElementById('ateAllCheckboxes').innerHTML = ateAllHTML;
            
            // Render table help checkboxes (only Berta and Kaj - b√∏rnene)
            const tableHelpHTML = `
                <div class="checkbox-item" onclick="toggleTableHelp('Berta', 'setTable', this)">
                    <span class="checkbox-item-emoji">üëßüçΩÔ∏è</span>
                    <span class="checkbox-item-text">Berta d√¶kkede bord</span>
                </div>
                <div class="checkbox-item" onclick="toggleTableHelp('Berta', 'clearTable', this)">
                    <span class="checkbox-item-emoji">üëßüßπ</span>
                    <span class="checkbox-item-text">Berta ryddede af</span>
                </div>
                <div class="checkbox-item" onclick="toggleTableHelp('Kaj', 'setTable', this)">
                    <span class="checkbox-item-emoji">üë∂üçΩÔ∏è</span>
                    <span class="checkbox-item-text">Kaj hjalp med at d√¶kke</span>
                </div>
                <div class="checkbox-item" onclick="toggleTableHelp('Kaj', 'clearTable', this)">
                    <span class="checkbox-item-emoji">üë∂üßπ</span>
                    <span class="checkbox-item-text">Kaj hjalp med at rydde</span>
                </div>
            `;
            document.getElementById('tableHelpCheckboxes').innerHTML = tableHelpHTML;
            
            // Render vegetable grid
            const veggieHTML = vegetables.map(veggie => `
                <div class="veggie-item" onclick="toggleVeggie('${veggie.name}', this)">
                    <span class="veggie-emoji">${veggie.emoji}</span>
                    <span class="veggie-name">${veggie.name}</span>
                </div>
            `).join('');
            document.getElementById('veggieGrid').innerHTML = veggieHTML;
            
            // Reset extra data
            extraData = {
                ateAll: [],
                vegetables: [],
                triedNew: false,
                helpedOut: false,
                tableHelp: {
                    setTable: [],
                    clearTable: []
                }
            };
            
            showScreen('extraQuestionsScreen');
        }
        
        function toggleTableHelp(name, action, element) {
            element.classList.toggle('checked');
            const index = extraData.tableHelp[action].indexOf(name);
            if (index > -1) {
                extraData.tableHelp[action].splice(index, 1);
            } else {
                extraData.tableHelp[action].push(name);
            }
        }
        
        function toggleAteAll(name, element) {
            element.classList.toggle('checked');
            const index = extraData.ateAll.indexOf(name);
            if (index > -1) {
                extraData.ateAll.splice(index, 1);
            } else {
                extraData.ateAll.push(name);
            }
        }
        
        function toggleVeggie(name, element) {
            element.classList.toggle('selected');
            const index = extraData.vegetables.indexOf(name);
            if (index > -1) {
                extraData.vegetables.splice(index, 1);
            } else {
                extraData.vegetables.push(name);
            }
        }
        
        function toggleCheckbox(element, type) {
            element.classList.toggle('checked');
            extraData[type] = !extraData[type];
        }
        
        function finishRating() {
            showSummary();
        }
        
        function askAboutQuiz() {
            // Kun sp√∏rg Berta om hun vil spille quiz
            const bertaRating = ratings['Berta'];
            
            // Hvis Berta ikke har rated (ikke til stede), spring quiz over
            if (bertaRating === undefined) {
                finishRating();
                return;
            }
            
            const wantsQuiz = confirm('üéØ BERTAS QUIZ TIME! üéØ\n\nVil Berta spille ingrediens-quiz og vinde point?\n\n‚úÖ Tryk OK for JA\n‚ùå Tryk Annuller for NEJ (spring over)');
            
            if (wantsQuiz) {
                startIngredientQuiz();
            } else {
                // Spring quizzen over og g√• direkte til sammenfatning
                finishRating();
            }
        }
        
        function startIngredientQuiz() {
            // Select random ingredients for quiz
            const allIngredients = [...vegetables, ...commonIngredients];
            
            // Get the actual ingredients from vegetables selection
            const actualIngredients = [...extraData.vegetables];
            
            // If no vegetables were selected, use random ones
            if (actualIngredients.length === 0) {
                const randomVeggies = vegetables.sort(() => Math.random() - 0.5).slice(0, 3);
                actualIngredients.push(...randomVeggies.map(v => v.name));
            }
            
            // Add 4-5 random ingredients that weren't selected as wrong answers
            const wrongAnswers = allIngredients
                .filter(ing => !actualIngredients.includes(ing.name))
                .sort(() => Math.random() - 0.5)
                .slice(0, 5);
            
            // Combine and shuffle (max 9 items for grid)
            const quizIngredients = [
                ...vegetables.filter(v => actualIngredients.includes(v.name)),
                ...commonIngredients.filter(c => actualIngredients.includes(c.name)),
                ...wrongAnswers
            ].sort(() => Math.random() - 0.5).slice(0, 9);
            
            let selectedAnswers = [];
            
            const berta = raters.find(r => r.name === 'Berta');
            
            const quizHTML = `
                <div class="rater-card">
                    <span class="rater-emoji" style="font-size: 100px;">${berta.emoji}</span>
                    <div class="rater-name">Bertas Quiz!</div>
                    <p style="font-size: 20px; color: #666; margin: 20px 0;">
                        Hvad var der i <strong>${currentDish}</strong>?<br>
                        <span style="font-size: 16px;">Tryk p√• alle de rigtige ingredienser!</span>
                    </p>
                    
                    <div class="veggie-grid" style="margin-top: 20px;">
                        ${quizIngredients.map((ing, idx) => `
                            <div class="veggie-item" id="quiz-item-${idx}" onclick="selectQuizAnswer('${ing.name}', ${idx})">
                                <span class="veggie-emoji">${ing.emoji}</span>
                                <span class="veggie-name">${ing.name}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="next-button" onclick="checkQuizAnswers()">Tjek svar! ‚úÖ</button>
                    </div>
                </div>
            `;
            
            document.getElementById('quizContent').innerHTML = quizHTML;
            showScreen('quizScreen');
            
            window.selectQuizAnswer = function(ingredient, idx) {
                const element = document.getElementById(`quiz-item-${idx}`);
                const isSelected = element.classList.contains('selected');
                
                if (isSelected) {
                    element.classList.remove('selected');
                    selectedAnswers = selectedAnswers.filter(a => a !== ingredient);
                } else {
                    element.classList.add('selected');
                    selectedAnswers.push(ingredient);
                }
            };
            
            window.checkQuizAnswers = function() {
                let correctCount = 0;
                let totalCorrect = actualIngredients.length;
                
                quizIngredients.forEach((ing, idx) => {
                    const element = document.getElementById(`quiz-item-${idx}`);
                    const isCorrect = actualIngredients.includes(ing.name);
                    const wasSelected = selectedAnswers.includes(ing.name);
                    
                    element.style.pointerEvents = 'none';
                    
                    if (isCorrect && wasSelected) {
                        // Correct answer - selected
                        element.style.background = '#d4edda';
                        element.style.borderColor = '#28a745';
                        element.innerHTML += '<div style="font-size: 24px; margin-top: 5px;">‚úÖ</div>';
                        correctCount++;
                        playCorrectSound();
                    } else if (isCorrect && !wasSelected) {
                        // Correct answer - NOT selected (missed)
                        element.style.background = '#fff3cd';
                        element.style.borderColor = '#ffc107';
                        element.innerHTML += '<div style="font-size: 20px; margin-top: 5px;">‚≠ï</div>';
                    } else if (!isCorrect && wasSelected) {
                        // Wrong answer - selected
                        element.style.background = '#f8d7da';
                        element.style.borderColor = '#dc3545';
                        element.innerHTML += '<div style="font-size: 24px; margin-top: 5px;">‚ùå</div>';
                    }
                });
                
                // Calculate score
                const score = correctCount;
                if (!quizScore['Berta']) quizScore['Berta'] = 0;
                quizScore['Berta'] += score;
                localStorage.setItem('quizScore', JSON.stringify(quizScore));
                
                // Show result
                setTimeout(() => {
                    if (score === totalCorrect) {
                        alert(`üéâ PERFEKT! ${score}/${totalCorrect} rigtige!\nBerta er en MESTER! üèÜ`);
                        createConfetti();
                    } else if (score >= totalCorrect / 2) {
                        alert(`üòä Godt klaret! ${score}/${totalCorrect} rigtige!\nN√¶sten perfekt, Berta! ‚≠ê`);
                    } else {
                        alert(`üëç Godt fors√∏g! ${score}/${totalCorrect} rigtige!\n√òv dig mere n√¶ste gang! üí™`);
                    }
                    
                    setTimeout(() => {
                        finishRating();
                    }, 1000);
                }, 1500);
            };
        }
        
        function playCorrectSound() {
            try {
                const ctx = getAudioContext();
                
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                const now = ctx.currentTime;
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            } catch (e) {
                console.log('Audio not supported:', e);
            }
        }
        
        // Badge system
        const badgeDefinitions = [
            // Rating badges
            { id: 'first_rating', name: 'F√∏rste rating!', emoji: 'üåü', description: 'Rate din f√∏rste ret', check: (user) => getUserRatingCount(user) >= 1 },
            { id: 'perfect_5', name: 'Perfekt 5!', emoji: '‚≠ê', description: 'Giv en ret 5 stjerner', check: (user) => userHasGiven5Stars(user) },
            { id: 'always_happy', name: 'Altid glad', emoji: 'üòä', description: 'Giv 10 ratings p√• 4+ stjerner', check: (user) => userHighRatingsCount(user) >= 10 },
            
            // Food badges
            { id: 'food_lover', name: 'Madentusiast', emoji: 'üçΩÔ∏è', description: 'Rate 10 forskellige retter', check: (user) => getUserUniqueDishes(user) >= 10 },
            { id: 'foodie', name: 'Foodie', emoji: 'ü§§', description: 'Rate 25 forskellige retter', check: (user) => getUserUniqueDishes(user) >= 25 },
            
            // Veggie badges
            { id: 'green_warrior', name: 'Gr√∏n kriger', emoji: 'ü•¶', description: 'Smag 5 forskellige gr√∏ntsager', check: (user) => getUserVeggieCount(user) >= 5 },
            { id: 'veggie_master', name: 'Veggie-mester', emoji: 'ü•¨', description: 'Smag 10 forskellige gr√∏ntsager', check: (user) => getUserVeggieCount(user) >= 10 },
            
            // Ate all badges
            { id: 'clean_plate', name: 'Ren tallerken', emoji: 'üçΩÔ∏è', description: 'Spis alt op', check: (user) => userAteAllCount(user) >= 1 },
            { id: 'no_waste', name: 'Ingen madspild', emoji: '‚ú®', description: '5 rene tallerkener i tr√¶k', check: (user) => userAteAllStreak(user) >= 5 },
            
            // Try new badges
            { id: 'brave', name: 'Modig', emoji: 'ü¶∏', description: 'Smag noget nyt', check: (user) => userTriedNewCount(user) >= 1 },
            { id: 'adventurer', name: 'Eventyrer', emoji: 'üåç', description: 'Smag 5 nye ting', check: (user) => userTriedNewCount(user) >= 5 },
            
            // Helper badges
            { id: 'helper', name: 'Hj√¶lper', emoji: 'üëè', description: 'Hj√¶lp til 3 gange', check: (user) => userHelpedCount(user) >= 3 },
            { id: 'table_setter', name: 'Bord-d√¶kker', emoji: 'üçΩÔ∏è', description: 'D√¶k bord 5 gange', check: (user) => userSetTableCount(user) >= 5 },
            { id: 'table_clearer', name: 'Oprydder', emoji: 'üßπ', description: 'Ryd af 5 gange', check: (user) => userClearTableCount(user) >= 5 },
            { id: 'super_helper', name: 'Super-hj√¶lper', emoji: '‚≠ê', description: 'D√¶k OG ryd af 10 gange', check: (user) => (userSetTableCount(user) + userClearTableCount(user)) >= 10 }
        ];
        
        function getUserRatingCount(user) {
            return history.filter(h => h.ratings[user] !== undefined).length;
        }
        
        function userHasGiven5Stars(user) {
            return history.some(h => h.ratings[user] === 5);
        }
        
        function userHighRatingsCount(user) {
            return history.filter(h => h.ratings[user] >= 4).length;
        }
        
        function getUserUniqueDishes(user) {
            const dishes = new Set();
            history.filter(h => h.ratings[user] !== undefined).forEach(h => dishes.add(h.dish));
            return dishes.size;
        }
        
        function getUserVeggieCount(user) {
            const veggies = new Set();
            history.forEach(h => {
                if (h.extraData && h.extraData.vegetables) {
                    h.extraData.vegetables.forEach(v => veggies.add(v));
                }
            });
            return veggies.size;
        }
        
        function userAteAllCount(user) {
            return history.filter(h => h.extraData && h.extraData.ateAll && h.extraData.ateAll.includes(user)).length;
        }
        
        function userAteAllStreak(user) {
            let maxStreak = 0;
            let currentStreak = 0;
            
            for (let i = history.length - 1; i >= 0; i--) {
                const h = history[i];
                if (h.extraData && h.extraData.ateAll && h.extraData.ateAll.includes(user)) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }
            return maxStreak;
        }
        
        function userTriedNewCount(user) {
            return history.filter(h => h.extraData && h.extraData.triedNew).length;
        }
        
        function userHelpedCount(user) {
            return history.filter(h => h.extraData && h.extraData.helpedOut).length;
        }
        
        function userSetTableCount(user) {
            return history.filter(h => 
                h.extraData && 
                h.extraData.tableHelp && 
                h.extraData.tableHelp.setTable && 
                h.extraData.tableHelp.setTable.includes(user)
            ).length;
        }
        
        function userClearTableCount(user) {
            return history.filter(h => 
                h.extraData && 
                h.extraData.tableHelp && 
                h.extraData.tableHelp.clearTable && 
                h.extraData.tableHelp.clearTable.includes(user)
            ).length;
        }
        
        function checkAndAwardBadges() {
            const newBadges = [];
            
            raters.forEach(rater => {
                badgeDefinitions.forEach(badge => {
                    if (!userBadges[rater.name].includes(badge.id) && badge.check(rater.name)) {
                        userBadges[rater.name].push(badge.id);
                        newBadges.push({ user: rater, badge: badge });
                    }
                });
            });
            
            return newBadges;
        }
        
        function showBadgePopup(user, badge) {
            playSuccessSound();
            createConfetti();
            
            const popup = document.getElementById('badgePopup');
            popup.innerHTML = `
                <div class="badge-popup-overlay" onclick="closeBadgePopup()"></div>
                <div class="badge-popup">
                    <div class="badge-icon">${badge.emoji}</div>
                    <div class="badge-title">Nyt Badge!</div>
                    <div style="font-size: 24px; margin-bottom: 10px;">${user.emoji} ${user.name}</div>
                    <div style="font-size: 20px; font-weight: 700; color: #333; margin-bottom: 10px;">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    <button class="big-button" onclick="closeBadgePopup()">Fedt! üéâ</button>
                </div>
            `;
            popup.style.display = 'block';
        }
        
        function playSuccessSound() {
            try {
                const ctx = getAudioContext();
                
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                const now = ctx.currentTime;
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                
                oscillator.start(now);
                oscillator.stop(now + 0.5);
            } catch (e) {
                console.log('Audio not supported:', e);
            }
        }
        
        function createConfetti() {
            const colors = ['#ffc107', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#dfe6e9'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        width: 10px;
                        height: 10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        left: ${Math.random() * 100}%;
                        top: -10px;
                        border-radius: 50%;
                        z-index: 9999;
                        animation: confetti-fall ${2 + Math.random() * 2}s linear;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }
        
        function closeBadgePopup() {
            document.getElementById('badgePopup').style.display = 'none';
        }
        
        function showBadges() {
            showScreen('badgesScreen');
            showBadgesFor('Mor');
        }
        
        function showBadgesFor(userName) {
            // Update button states
            ['Mor', 'Far', 'Berta', 'Kaj'].forEach(name => {
                const btn = document.getElementById(name.toLowerCase() + 'BadgeBtn');
                if (btn) {
                    btn.style.background = name === userName ? '#667eea' : '#17a2b8';
                }
            });
            
            const user = raters.find(r => r.name === userName);
            const earnedBadges = userBadges[userName] || [];
            
            const badgesHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 60px; margin-bottom: 10px;">${user.emoji}</div>
                    <div style="font-size: 32px; font-weight: 700; color: #333;">${userName}</div>
                    <div style="font-size: 20px; color: #666; margin-top: 10px;">
                        ${earnedBadges.length} / ${badgeDefinitions.length} badges
                    </div>
                    ${userName === 'Berta' ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                    color: white; padding: 15px; border-radius: 15px; margin-top: 15px;">
                            <div style="font-size: 18px;">üéØ Quiz Score</div>
                            <div style="font-size: 36px; font-weight: 700;">${quizScore[userName] || 0} point</div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="badge-grid">
                    ${badgeDefinitions.map(badge => {
                        const earned = earnedBadges.includes(badge.id);
                        return `
                            <div class="badge-card ${earned ? 'earned' : 'locked'}">
                                <div class="badge-card-icon">${badge.emoji}</div>
                                <div class="badge-card-name">${badge.name}</div>
                                ${earned ? 
                                    '<div style="color: #28a745; font-size: 12px; margin-top: 5px;">‚úì Optjent</div>' : 
                                    '<div style="color: #999; font-size: 12px; margin-top: 5px;">üîí L√•st</div>'
                                }
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('badgesContent').innerHTML = badgesHTML;
        }
        
        function showSummary() {
            const total = Object.values(ratings).reduce((a, b) => a + b, 0);
            const average = (total / Object.values(ratings).length).toFixed(1);
            
            const summaryHTML = `
                ${Object.entries(ratings).map(([name, stars]) => {
                    const rater = raters.find(r => r.name === name);
                    return `
                        <div class="summary-card">
                            <div class="summary-name">${rater.emoji} ${name}</div>
                            <div class="summary-stars">${'‚òÖ'.repeat(stars)}${'‚òÜ'.repeat(5-stars)}</div>
                        </div>
                    `;
                }).join('')}
                
                <div class="average-card">
                    <div style="font-size: 28px; font-weight: 600;">Gennemsnit</div>
                    <div class="average-score">${average} ‚≠ê</div>
                    <div style="font-size: 24px;">${currentDish}</div>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = summaryHTML;
            showScreen('summaryScreen');
            
            // Save to history with extra data
            history.unshift({
                dish: currentDish,
                ratings: {...ratings},
                average: parseFloat(average),
                date: new Date().toISOString(),
                extraData: {...extraData}
            });
            saveHistory();
            
            // Check for new badges
            const newBadges = checkAndAwardBadges();
            if (newBadges.length > 0) {
                // Show first badge popup after a short delay
                setTimeout(() => {
                    showBadgePopupsSequentially(newBadges, 0);
                }, 1000);
            }
        }
        
        function showBadgePopupsSequentially(newBadges, index) {
            if (index >= newBadges.length) return;
            
            const badge = newBadges[index];
            showBadgePopup(badge.user, badge.badge);
            
            // Override close button to show next badge
            const originalClose = window.closeBadgePopup;
            window.closeBadgePopup = function() {
                document.getElementById('badgePopup').style.display = 'none';
                setTimeout(() => {
                    showBadgePopupsSequentially(newBadges, index + 1);
                }, 500);
            };
        }
        
        function showHistory() {
            const historyHTML = history.length === 0 ? 
                '<p style="text-align: center; color: #999; padding: 40px;">Ingen retter rated endnu! üçΩÔ∏è</p>' :
                history.map((item, index) => {
                    const date = new Date(item.date);
                    const dateStr = date.toLocaleDateString('da-DK', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    return `
                        <div class="history-item" style="position: relative;">
                            <button onclick="deleteHistoryItem(${index})" 
                                    style="position: absolute; top: 15px; right: 15px; 
                                           background: #dc3545; color: white; border: none; 
                                           padding: 8px 15px; border-radius: 10px; cursor: pointer;
                                           font-size: 14px; font-weight: 600;">
                                üóëÔ∏è Slet
                            </button>
                            <div class="history-dish">${item.dish}</div>
                            <div class="history-date">${dateStr}</div>
                            <div style="font-size: 24px; color: #ffc107; margin: 10px 0;">
                                Gennemsnit: ${item.average} ‚≠ê
                            </div>
                            <div class="history-ratings">
                                ${Object.entries(item.ratings).map(([name, stars]) => {
                                    const rater = raters.find(r => r.name === name) || { emoji: 'üë§', name: name };
                                    return `
                                        <div class="history-rating">
                                            ${rater.emoji} ${name}: ${'‚òÖ'.repeat(stars)}${'‚òÜ'.repeat(5-stars)}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('historyList').innerHTML = historyHTML;
            showScreen('historyScreen');
        }
        
        function deleteHistoryItem(index) {
            const item = history[index];
            if (confirm(`Slet "${item.dish}"?\n\nDette kan ikke fortrydes! üóëÔ∏è`)) {
                history.splice(index, 1);
                saveHistory();
                showHistory(); // Refresh the list
            }
        }
        
        function showDishScreen() {
            showScreen('dishScreen');
        }
        
        function showReports() {
            showScreen('reportsScreen');
            showReport('week');
        }
        
        function showReport(period) {
            // Update button states
            document.querySelectorAll('.history-button').forEach(btn => {
                btn.style.background = '#17a2b8';
            });
            document.getElementById(period + 'Btn').style.background = '#667eea';
            
            const now = new Date();
            let filteredHistory = [];
            
            if (period === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredHistory = history.filter(item => new Date(item.date) >= weekAgo);
            } else if (period === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredHistory = history.filter(item => new Date(item.date) >= monthAgo);
            } else {
                filteredHistory = history;
            }
            
            if (filteredHistory.length === 0) {
                document.getElementById('reportContent').innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px;">
                        Ingen data for denne periode üìä
                    </p>
                `;
                return;
            }
            
            // Calculate statistics
            const totalMeals = filteredHistory.length;
            const totalRating = filteredHistory.reduce((sum, item) => sum + item.average, 0);
            const avgRating = (totalRating / totalMeals).toFixed(1);
            
            // Find top dishes
            const dishStats = {};
            filteredHistory.forEach(item => {
                if (!dishStats[item.dish]) {
                    dishStats[item.dish] = {
                        count: 0,
                        totalRating: 0,
                        ratings: []
                    };
                }
                dishStats[item.dish].count++;
                dishStats[item.dish].totalRating += item.average;
                dishStats[item.dish].ratings.push(item.average);
            });
            
            const topDishes = Object.entries(dishStats)
                .map(([dish, stats]) => ({
                    dish,
                    count: stats.count,
                    avgRating: (stats.totalRating / stats.count).toFixed(1)
                }))
                .sort((a, b) => b.avgRating - a.avgRating)
                .slice(0, 5);
            
            // Calculate rater stats
            const raterStats = {};
            raters.forEach(rater => {
                raterStats[rater.name] = {
                    emoji: rater.emoji,
                    ratings: [],
                    avg: 0
                };
            });
            
            filteredHistory.forEach(item => {
                Object.entries(item.ratings).forEach(([name, rating]) => {
                    if (raterStats[name]) {
                        raterStats[name].ratings.push(rating);
                    }
                });
            });
            
            Object.keys(raterStats).forEach(name => {
                const ratings = raterStats[name].ratings;
                if (ratings.length > 0) {
                    raterStats[name].avg = (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1);
                }
            });
            
            // Generate report HTML
            const periodName = period === 'week' ? 'Denne uge' : period === 'month' ? 'Denne m√•ned' : 'Hele perioden';
            
            const reportHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div class="report-stat-card">
                        <div class="report-stat-label">Antal retter</div>
                        <div class="report-stat-number">${totalMeals}</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-label">Gennemsnit</div>
                        <div class="report-stat-number">${avgRating} ‚≠ê</div>
                    </div>
                </div>
                
                <h3 style="font-size: 28px; margin-bottom: 20px; color: #333;">üèÜ Top ${topDishes.length} Retter</h3>
                ${topDishes.map((dish, index) => `
                    <div class="top-dish-card" style="${index === 0 ? 'border-color: #ffc107;' : index === 1 ? 'border-color: #c0c0c0; background: #f0f0f0;' : index === 2 ? 'border-color: #cd7f32; background: #ffeedd;' : 'border: 2px solid #e0e0e0; background: #f8f9fa;'}">
                        <div class="top-dish-name">${index + 1}. ${dish.dish}</div>
                        <div class="top-dish-rating">${dish.avgRating} ‚≠ê</div>
                        <div class="top-dish-count">Spist ${dish.count} ${dish.count === 1 ? 'gang' : 'gange'}</div>
                    </div>
                `).join('')}
                
                <h3 style="font-size: 28px; margin: 30px 0 20px; color: #333;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familiens Ratings</h3>
                <div class="rater-stats">
                    ${Object.entries(raterStats).map(([name, stats]) => `
                        <div class="rater-stat-card">
                            <div class="rater-stat-emoji">${stats.emoji}</div>
                            <div class="rater-stat-name">${name}</div>
                            <div class="rater-stat-avg">${stats.avg} ‚≠ê</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                ${stats.ratings.length} ratings
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHTML;
        }
        
        function reset() {
            document.getElementById('dishInput').value = '';
            // Remove any guest raters
            for (let i = raters.length - 1; i >= 0; i--) {
                if (raters[i].isGuest) {
                    raters.splice(i, 1);
                }
            }
            showDishScreen();
        }
        
        // Initialize
        loadHistory();
    </script>
</body>
</html>
